---
title: |
  ![](logoUCO.png){width=10%}
  Breast Cancer Gene Expression Profiles
  ![](logofac.png){width=13%}
  (METABRIC)
  
author: "Andrea Murillo Espinar, Andrea Torres Philpott"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    highlight: tango # colores 
    css: estilos_personalizados.css
    toc: true
    toc_float: true
    number_sections: true
    fig_caption: true
bibliography: ["breast_cancer.bib", "libraries.bib"]
link-citations: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#instala los paquetes si no los tienes
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("FSA")
#install.packages("survival")
#install.packages("survminer")
#install.packages("stats")
#install.packages("knitr")
#install.packages("bookdown")
```


```{r, warning=FALSE, message=FALSE, echo=FALSE}
#cargo las dependencias
library(dplyr) #para manipulación y limpieza de datos
library(ggplot2) #para la generación de gráficos
library(FSA) #para la función dunnTest(): post-hoc
library(survival) #para generar los objetos de la supervivencia
library(survminer) #para la creación de curvas de supervivencia
library(stats) #para realización de test de normalidad, kruskal..
library(knitr) #combinación de texto, gráficos..
library(bookdown) #para que la numeración y pie de figuras funcionen correctamente
```

# **Introducción**
El cáncer de mama es una enfermedad que presenta una amplia variabilidad tanto a nivel clínico como molecular. En un inicio se clasificaba en base al **grado tumoral**, el **tamaño** o el **estado ganglionar**, pero estos criterios son insuficientes para poder explicar las diferencias en el pronóstico y la respuesta al tratamiento que se observan entre pacientes incluso con características clínicas similares. (@perouMolecularPortraitsHuman2000)\  

El desarrollo de las tecnologías de análisis de expresión génica a gran escala (microarrays o secuenciación de ARN) ha permitido una caracterización más precisa a nivel molecular del cáncer de mama. Los primeros estudios demostraron que se pueden agrupar los tumores mamarios en **subtipos moleculares** *distintos* y cada uno de ellos, con características biológicas y clínicas específicas. Entre los subtipos encontramos: *Luminal A*, *Luminal B*, *HER2-positivo*, *Claudin-low* y *Basal-like*, los cuales difieren en la expresión de genes relacionados con receptores hormonales, proliferación celular y vías oncogénicas clave. (@sorlieRepeatedObservationBreast2003)\  

El conjunto de datos [Breast Cancer Gene Expression Profiles]{style="color:purple;"} nos proporciona información sobre los perfiles de expresión génica y variables clínicas asociadas a tumores de mama, permitiéndonos explorar de manera estadística la relación entre los subtipos moleculares y distintas características biológicas del tumor.\   

# Materiales y métodos

## Tratamiento y análisis de datos
Con la librería `dplyr` hemos seleccionado, manipulado y limpiado la base de datos. [@R-dplyr]  

El análisis de supervivencia se realizó con el paquete `survival` : incluye curvas de Kaplan-Meier y los modelos de regresión de Cox (Univariante y Multivariante) [@survival-package; @survival-book]  

Para la comparación entre grupos en el análisis no paramétrico se utilizó la prueba post-hoc Dunn's, mediante el paquete `FSA`. [@fsa]  

## Visualización
Las gráficas se realizaron con el paquete `ggplot2` [@R-ggplot2; @ggplot22016]
Para la representación de las curvas de Kaplan-Meier empleamos el paquete `survminer` [@survminer]  

## Generación del informe
Para la creación de este informe hemos utilizado el paquete knitr [@R-knitr; @knitr2015, @knitr2014] y pandoc.  


# Tratamiento de datos
Con la información proporcionada por la base de datos, dividimos los datos en *datos clínicos* y *datos genéticos*

```{r, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
data <- read.csv("C:/Users/usuario/Downloads/archive/METABRIC_RNA_Mutation.csv") # Cargamos la base de datos descargada de Kaggle

col_datosclinicos <- colnames(data) %>% 
  head(n = 31) # Muestro base de datos parcialmente

datos_clinicos <- data %>% 
  select(col_datosclinicos) # Selecciono datos clinicos de toda la base de datos (data)

# Convierto valores vacíos a NA
datos_clinicos[datos_clinicos == ""] <- NA
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
dim(datos_clinicos) # Veo las dimensiones de la tabla
str(datos_clinicos) 
```

```{r datosgeneticos, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Hago lo mismo pero para los datos genéticos
datos_geneticos <- data %>% 
  select(32:693) # Sabemos que el resto son genéticos
```
La base de datos global tiene `r nrow(data)` filas y `r ncol(data)` columnas.
Cada fila se corresponde con un paciente, por tanto, hay `r nrow(datos_clinicos)` pacientes.\  

Los *datos clínicos* tienen `r nrow(datos_clinicos)` filas y `r ncol(datos_clinicos)` columnas.\  

Los *datos genéticos* tienen `r nrow(datos_geneticos)` filas y `r ncol(datos_geneticos)` columnas.\  

# Dataset (METABRIC)
Esta base de datos ha sido usada por @mucakiPredictingOutcomesHormone2017 y @mukherjeeAssociationsGenomicStratification2018

# Supervivencia en función del estadio del tumor
```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# 1. Limpieza y preparación de datos
datos_grafico_tumor <- datos_clinicos %>%
  # 1.2. Lo convierto a carácter para manejar la cadena vacía
  mutate(tumor_stage = as.character(tumor_stage)) %>%
  # 1.3. Convierto espacios vacíos ("") a NA
  mutate(tumor_stage = na_if(tumor_stage, "")) %>%
  # 1.4. Filtro todos los NA (los originales y los recién creados)
  filter(!is.na(tumor_stage)) %>%
  # 1.5. Convierto la columna a factor para la gráfica
  mutate(tumor_stage = factor(tumor_stage, ordered = TRUE)) # Aseguramos que esté ordenado


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Supervivencia Global por etapa del Tumor(METABRIC)."}
# 2. Genero el Box Plot
boxplot_supervivenciafinal <- datos_grafico_tumor %>%
  ggplot(aes(x = tumor_stage, y = overall_survival_months, fill = tumor_stage)) +
  geom_boxplot(show.legend= FALSE) +
  geom_jitter(color="black", size=0.4, alpha=0.5, show.legend = FALSE) +
  labs(
    title= "Supervivencia Global en función del estadio del tumor",
    x = "Etapa del Tumor",
    y = "Supervivencia Global (Meses)",
    fill = "Etapa"
  ) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_viridis_d(option= "D") # Colourblind friendly

print(boxplot_supervivenciafinal) # Muestro el resultado final
```

¿Son datos significativos?\  

## Test de normalidad

Primero realizamos una prueba de normalidad mediante `shapiro.test`.

H~0~: La distribución de la supervivencia global sigue una distribución normal \    

H~1~: La distribución de la supervivencia global no sigue una distribución normal

Como p= 2.2e-16 < 0.05, rechazamos la hipótesis nula y aceptamos la hipótesis alternativa, la distribución de mis datos no siguen una distribución normal.

## Test de Kruskal wallis

Para ver si existen diferencias significativas en la supervivencia global entre las etapas del tumor, realizamos un test de Kruskal Wallis, ya que mis datos siguen una distribución no paramétrica.

H~0~: No existen diferencias significativas entre las etapas del tumor\   
H~1~: Existen diferencias significativas entre las etapas del tumor

Como p= 2.2e-16 < 0.05, rechazamos la hipótesis nula y aceptamos la hipótesis alternativa, existen diferencias significativas entre las etapas del tumor

## Test post-hoc Dunn's
Para ver entre qué grupos existe diferencia significativa

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Existen diferencias significativas?

# Comprobamos normalidad
shapiro.test(datos_grafico_tumor$overall_survival_months) # Siguen una distribución no normal
kruskal.test(overall_survival_months ~ tumor_stage, data= datos_grafico_tumor) # Existen diferencias

# 1. Preparar el data frame para Dunn's Test
# Usamos las columnas de supervivencia y el tumor_stage limpio.
datos_dunn <- datos_clinicos %>%
  # Limpieza del tumor_stage
  mutate(tumor_stage = as.character(tumor_stage)) %>%
  mutate(tumor_stage = na_if(tumor_stage, "")) %>%
  filter(!is.na(tumor_stage) & !is.na(overall_survival_months)) %>%
  
  # Aseguramos que la variable de agrupamiento (tumor stage) es un factor
  mutate(tumor_stage = factor(tumor_stage))

# 2. Ejecutamos el Test de Dunn con corrección de Bonferroni
resultado_dunn <- dunnTest(overall_survival_months ~ tumor_stage,
                           data = datos_dunn, 
                           method = "bonferroni")

print("Resultado del Test Post-Hoc de Dunn (Bonferroni):")
print(resultado_dunn)
```

La tasa de supervivencia es mayor en la etapa 1, es significativamente diferente de la 2, 3 y 4.
Diferencia de etapa 2 a 3, mejor tasa de supervivencia en la 2.
A mayor etapa de tumor, peor supervivencia.

# Carga mutacional por subtipo de cáncer de mama
```{r cancersubtipos, echo=FALSE, message=FALSE, warning=FALSE}
# Vamos a hacerlo otra vez omitiendo NC
  # Limpieza y preparación de datos (Ajustado)
datos_combinados <- data %>% 
select(`pam50_._claudin.low_subtype`, mutation_count) %>% 
    
    # AÑADO FILTRO PARA ELIMINAR "NC" (Not Classified)
filter(!is.na(`pam50_._claudin.low_subtype`) & 
             !is.na(mutation_count) & 
             `pam50_._claudin.low_subtype` != "NC") 
  
  # Después de filtrar, R puede conservar los niveles 'NC' en la metadata.
  # Para asegurarnos de que desaparezca del gráfico, convertimos la columna a factor, 
  # Fuerzo a R a recalcular los niveles (se hace automáticamente si la columna ya era factor).
  datos_combinados <- datos_combinados %>%
    mutate(`pam50_._claudin.low_subtype` = factor(`pam50_._claudin.low_subtype`))
  
  
  # Creo el Box-Violin Plot
  datos_combinados %>% 
    ggplot(aes(x = `pam50_._claudin.low_subtype`, y = mutation_count, fill = `pam50_._claudin.low_subtype`)) +
    geom_violin(alpha = 0.6, show.legend = FALSE) + 
    geom_boxplot(width = 0.1, color = "black", alpha = 0.7, show.legend = FALSE) + 
    labs(
      title = "Carga Mutacional por Subtipo Molecular PAM50",
      x = "Subtipo Molecular",
      y = "Conteo de Mutaciones",
      fill = "Subtipo" 
    ) +
    theme_bw() +
    scale_fill_viridis_d()

```


# Pronóstico cáncer Her2+

## Modelo univariante

Seleccionamos variables de supervivencia y subtipo Her2.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Quiero relacionar survival months con her2_status: el cáncer her2+ es más agresivo frente al her2-, mi hipótesis es que va a tener menor supervivencia los her2+
unique(datos_clinicos$her2_status)
str(datos_clinicos$her2_status)

# Importante que no tenga NA y que sea un factor, como antes
datos_her2 <- datos_clinicos %>%
  filter(!is.na(her2_status)) %>%
  # Convertimos a factor, aunque es probable que ya lo sea
  mutate(her2_status = factor(her2_status))
str(datos_her2) # Ahora sí es un factor


unique(datos_clinicos$overall_survival)
str(datos_clinicos$overall_survival_months)


## 2. Creamos el objeto de supervivencia
# Tiempo: overall_survival_months
# Evento: overall_survival (1=fallecido, 0=vivo/censurado)
surv_object_her2 <- Surv(time = datos_her2$overall_survival_months, 
                         event = datos_her2$overall_survival)

# 3. Ajustamos el Modelo de Kaplan-Meier
# Ajustamos la supervivencia en función del estado HER2
fit_km_her2 <- survfit(surv_object_her2 ~ her2_status, data = datos_her2)

# 4. Generamos el Gráfico y el Log-rank Test
km_her2_plot <- ggsurvplot(fit_km_her2, 
                           data = datos_her2,
                           pval = TRUE,             # Muestra el valor p de la prueba Log-rank
                           risk.table = TRUE,       # Muestra la tabla de riesgo
                           legend.title = "Estado HER2",
                           title = "Curvas de Supervivencia Global por Estado HER2",
                           palette = c("purple4", "#2E9FDF") # Colores para HER2- y HER2+
)

print(km_her2_plot) # Muestro el resultado final
```

```{r}
# Calculamos el Modelo de Cox
# La fórmula es: objeto_supervivencia ~ predictor
cox_her2_model <- coxph(surv_object_her2 ~ her2_status, 
                        data = datos_her2)

# 2. Imprimimos el resumen del modelo para obtener el Hazard Ratio (HR)
print("--- Resumen del Modelo de Cox para Estado HER2 ---")
summary(cox_her2_model)
```

Interpretación: existen diferencias significativas en la supervivencia global entre subtipos Her2+ y Her2-.
El cáncer de mama Her2+ se asocia con un riesgo de muerte de 33,91% mayor en cualquier momento en comparación con otros subtipos de cáncer de mama.

## Modelo multivariante

Hacemos un modelo multivariante para ver si el riesgo asociado a Her2 se ve afectado por otros factores como: etapa del tumor, edad, quimioterapia.
```{r}
# 1. Seleccionamos y limpiamos solo las filas necesarias para el modelo multivariante
datos_multivariante <- datos_clinicos %>%
  select(overall_survival_months, overall_survival, # Variables de tiempo/evento
         her2_status, tumor_stage, age_at_diagnosis, chemotherapy) %>% # Covariables
  
  # Filtramos NAs de las variables del modelo
  filter(!is.na(her2_status) & 
           !is.na(tumor_stage) & 
           !is.na(age_at_diagnosis) & 
           !is.na(chemotherapy)) %>%
  
  # Las variables categóricas tienen que ser factores
  mutate(her2_status = factor(her2_status),
         tumor_stage = factor(tumor_stage),
         chemotherapy = factor(chemotherapy)) 
```



```{r}
# 2. Creamos el objeto de supervivencia (Surv Object)
surv_object_multi <- Surv(time = datos_multivariante$overall_survival_months, 
                          event = datos_multivariante$overall_survival)
```


```{r}
# 3. Modelo de Cox Multivariante
cox_multivariante_model <- coxph(
  surv_object_multi ~ her2_status + tumor_stage + age_at_diagnosis + chemotherapy,
  data = datos_multivariante
)
```


```{r}
# 4. Muestro resultado del modelo
summary(cox_multivariante_model) 
```

El factor que más afecta al riesgo de muerte es la quimioterapia, ya que p<0.05, HR: 1.85 Esto significa que los pacientes que recibieron quimioterapia tienen un riesgo de muerte 1.85 veces (85% de riesgo) mayor que aquellos que no la recibieron. 

Sesgo de selección: La quimioterapia no está causando la muerte. Es un tratamiento administrado a pacientes con cáncer avanzado, más agresivo, con peor pronóstico. Por lo tanto, el modelo muestra la asociación entre la quimioterapia y el riesgo.

El estado her2+, en análisis univariante es pronóstico, pero no es un predictor en la supervivencia si se hace un modelo con quimioterapia y estadio tumoral


# Pronóstico cáncer Triple negativo

Ahora vamos a ver el pronóstico del cáncer Triple negativo, se define por la ausencia de tres receptores, ER (receptor de estrógeno), PR (receptor de progesterona) y receptor HER2-
```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
unique(datos_clinicos$er_status)
unique(datos_clinicos$pr_status)
unique(datos_clinicos$her2_status)
```

Asumimos que "Negative" significa ausencia de receptor.
Usaremos el data frame original de datos clínicos.
```{r, echo=FALSE, message=FALSE, warning=FALSE}
datos_tnbc <- datos_clinicos %>%
  select(overall_survival_months, overall_survival, 
         er_status, pr_status, her2_status) %>%
  
  # 1. Creamos la variable TNBC_status, subtipo triple negativo.
  mutate(
    TNBC_status = case_when(
      er_status == "Negative" & pr_status == "Negative" & her2_status == "Negative" ~ "TNBC",
      TRUE ~ "Non_TNBC"
    )
  ) %>%
  
  # 2. Filtramos filas con NAs en los marcadores de supervivencia
  filter(!is.na(overall_survival_months) & !is.na(overall_survival)) %>%
  
  # 3. Convertimos a factor para el análisis
  mutate(TNBC_status = factor(TNBC_status))

# 4. Creamos el objeto de supervivencia
surv_object_tnbc <- Surv(datos_tnbc$overall_survival_months, 
                         datos_tnbc$overall_survival)
# A. Kaplan-Meier (Vemos la diferencia visual y obtenemos el p-valor)
km_tnbc <- survfit(surv_object_tnbc ~ TNBC_status, data = datos_tnbc)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggsurvplot(km_tnbc, 
           data = datos_tnbc,
           pval = TRUE,             # Muestro p-valor
           risk.table = TRUE,       # Muestro tabla de riesgo
           legend.title = "Estado Triple Negativo",
           title = "Supervivencia Global (TNBC vs. No-TNBC)")

# B. Modelo de Cox (Cuantifico el riesgo HR)
cox_tnbc_model <- coxph(surv_object_tnbc ~ TNBC_status, data = datos_tnbc)

print("Resumen del Modelo de Cox para TNBC:")
summary(cox_tnbc_model)

```

Existen diferencias significativas, "El cáncer de mama Triple Negativo (TNBC) se asocia con un riesgo de muerte 21.24% mayor en cualquier momento dado en comparación con otros subtipos de cáncer de mama (No-TNBC)


# Menopausia y cáncer de mama

Quiero ver cuantas pacientes son pre/post menopáusicas\  

Creo un data frame limpio solo con la variable de interés, eliminando valores vacíos o NAs.
```{r dfmenop, echo=FALSE, message=FALSE, warning=FALSE}
#  Limpieza y preparación 
datos_grafico_menopausia <- datos_clinicos %>%
  filter(!is.na(inferred_menopausal_state) & inferred_menopausal_state != "") %>%
  mutate(inferred_menopausal_state = factor(inferred_menopausal_state))

```


Genero el gráfico de barras
```{r graficomenop, echo=FALSE, message=FALSE, warning=FALSE}
grafico_barras_menopausia <- ggplot(datos_grafico_menopausia, 
                                    aes(x = inferred_menopausal_state, fill = inferred_menopausal_state)) +
  geom_bar() +
  
  # Añado las etiquetas de conteo encima de cada barra
  geom_text(stat = 'count', aes(label = after_stat(count)), vjust = -0.5, size = 5) +
  
  labs(title = "Distribución de Pacientes por Estado Menopáusico",
       x = "Estado Menopáusico",
       y = "Número de Pacientes") +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) +
  scale_fill_viridis_d(option= "D") +
  coord_cartesian(ylim = c(0, 1600)) #ajuste de eye de la Y

print(grafico_barras_menopausia)
```

# Conclusión
El análisis de los perfiles de expresión génica en cáncer de mama constituye una herramienta fundamental para comprender la complejidad biológica de los distintos subtipos de esta enfermedad. Los estudios actuales demuestran que la integración de datos genómicos y clínicos permiten identificar los subgrupos con diferencias pronósticas y terapéuticas claras, es decir, no solo mejora la clasificación molecular de los tumores, sino que además ofrece información valiosa para decidir clínicamente. [@amevorIntegrativePrognosticModeling2025]
Estos avances indican que la bioinformática no solo ayuda a entender de manera molecular al cáncer de mama, sino que también tiene un impacto directo en la calidad de vida de las pacientes, ya que, posibilita tratamientos más personalizados y mejora la predicción de resultados clínicos, contribuyendo a estrategias terapéuticas más eficaces y menos tóxicas. [@hsiehMultigeneExpressionAssays2025]

# Reproducibilidad
Para asegurar la reproducibilidad de los resultados es necesario conocer el sistema operativo y la versión de software y paquetes

## Información de la sesión y referencias
```{r sesion-info, echo=FALSE}
session <- sessionInfo()
print(session)
```

# Bibliografía 

